{% load hijack_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>

    {% block immediatescripts %}{% endblock immediatescripts %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
        ITticket - {% block title %}{% endblock %}
    </title>
    <link rel="stylesheet" type="text/css" href="{% static 'hijack/hijack-styles.css' %}"/>

    {% block stylesheets %}


    {% endblock stylesheets %}
    <link rel="stylesheet" href="{% static 'assets/css/custom.css' %}">

</head>
<body class="{{ request.user.microsoftprofile.dark_mode_active|yesno:"dark-mode,," }} hold-transition layout-top-nav{% block body_class %}{% endblock body_class %}">
{% hijack_notification %}
<div class="wrapper">

    {% include 'includes/navigation.html' %}

    {% block content %}{% endblock content %}

    {% include 'includes/footer.html' %}

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->

</div>
<!-- ./wrapper -->

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}

<script>
  window.CURRENT_USER_ID = {{ request.user.id|default:"null" }};
</script>

<script>
(function () {
  // ---------- Konfiguration ----------
  const ICON  = "{% static 'icons/icon-192.png' %}";  // passe Pfade an, wenn du willst
  const BADGE = "{% static 'icons/badge-72.png' %}";  // optional; wenn nicht vorhanden, bleibt's egal

  // ---------- Hilfen ----------
  function showToast(title, body, url) {
    const el = document.createElement("div");
    el.style.cssText = "position:fixed;right:20px;bottom:20px;z-index:9999;max-width:360px;background:#4f46e5;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.25);cursor:pointer;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;";
    el.innerHTML = `<div style="font-weight:600;margin-bottom:4px">${title}</div><div style="opacity:.95;font-size:14px;line-height:1.35">${body}</div>`;
    el.onclick = () => { if (url) window.location.href = url; };
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 8000);
  }

  function showPermissionBanner() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") return;

    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;left:50%;transform:translateX(-50%);bottom:0;width:100%;max-width:720px;background:#111827;color:#fff;padding:10px 14px;z-index:9999;border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -4px 18px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;";
    bar.innerHTML = `
      <div style="flex:1;font:500 14px/1.3 system-ui;">ðŸ”” MÃ¶chtest du System-Benachrichtigungen erhalten?</div>
      <button id="notif-allow" style="background:#10b981;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer;">Aktivieren</button>
      <button id="notif-dismiss" style="background:transparent;color:#9ca3af;border:1px solid #374151;border-radius:10px;padding:8px 12px;cursor:pointer;">SpÃ¤ter</button>
    `;
    document.body.appendChild(bar);
    bar.querySelector("#notif-allow").onclick = async () => {
      try { await Notification.requestPermission(); } catch(e) {}
      bar.remove();
      // Kleines Feedback
      if (Notification.permission === "granted") showToast("Benachrichtigungen aktiviert", "Du erhÃ¤ltst jetzt System-Hinweise.", null);
      else showToast("Benachrichtigungen blockiert", "Du kannst das in den Website-Einstellungen Ã¤ndern.", null);
    };
    bar.querySelector("#notif-dismiss").onclick = () => bar.remove();
  }

  function sendOSNotification(title, body, url) {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;
    try {
      const n = new Notification(title || "Ticket-System", {
        body: body || "",
        icon: ICON,
        badge: BADGE
      });
      n.onclick = () => { window.focus(); if (url) window.location.href = url; n.close(); };
    } catch (e) {
      // Falls Browser/Policy blockiert, einfach schweigen
    }
  }

  // ---------- WebSocket mit Reconnect (ohne Reload) ----------
  let ws = null, retry = 0, maxRetryDelay = 30000;
  function connectWS() {
    if (!("WebSocket" in window)) return;
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${protocol}://${location.host}/ws/notifications/`);

    ws.onopen = function () { retry = 0; /* verbunden */ };

    ws.onmessage = function (e) {
      let data = {};
      try { data = JSON.parse(e.data); } catch (_) {}

      if (data.creator_id && window.CURRENT_USER_ID && Number(data.creator_id) === Number(window.CURRENT_USER_ID)) {
        return;
      }

      const title = data.title || "Hinweis";
      const body  = data.message || "";
      const url   = data.url || "#";
      // 1) OS-Banner
      sendOSNotification(title, body, url);
      // 2) In-App-Toast (fÃ¼r den Fall, dass OS-Banner blockiert sind)
      showToast(title, body, url);
    };

    ws.onclose = function () {
      // sanfter Reconnect (exponential backoff)
      retry = Math.min(retry + 1, 8);
      const delay = Math.min(1000 * Math.pow(2, retry), maxRetryDelay);
      setTimeout(connectWS, delay);
    };

    ws.onerror = function () {
      try { ws.close(); } catch(_) {}
    };
  }

  // ---------- Start ----------
  showPermissionBanner();
  connectWS();
})();
</script>

</body>
</html>
